<!DOCTYPE html>
<html>
<head>
    <title>Agora Voice Chat Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* Inline CSS */
        body { font-family: sans-serif; background-color: #2c3e50; color: #ecf0f1; display: flex; justify-content: center; align-items: center; height: 100vh; margin: 0; }
        .container { background-color: #34495e; padding: 25px; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; max-width: 90%; }
        h1 { margin-top: 0; color: #1abc9c; }
        input { width: 100%; padding: 10px; margin-bottom: 15px; border-radius: 5px; border: 1px solid #7f8c8d; background-color: #2c3e50; color: white; font-size: 14px; }
        button { width: 100%; padding: 12px; font-size: 16px; font-weight: bold; border: none; border-radius: 5px; cursor: pointer; background-color: #27ae60; color: white; transition: background-color 0.3s; }
        button.active { background-color: #c0392b; }
        #statusLog { margin-top: 20px; padding: 10px; background-color: #2c3e50; border-radius: 5px; text-align: left; height: 150px; overflow-y: auto; font-size: 12px; }
        .log-entry { margin-bottom: 5px; padding-bottom: 5px; border-bottom: 1px solid #34495e; }
        .log-error { color: #e74c3c; font-weight: bold; }
    </style>
</head>
<body>

    <div class="container">
        <h1>Agora Voice Chat Test</h1>
        <input type="text" id="appIdInput" placeholder="Enter Your Agora App ID" value="f33cf29d42264f55b5130f61686e77a2">
        <button id="toggleVoiceBtn">Start Microphone</button>
        <div id="statusLog">
            <!-- Logs will appear here -->
        </div>
    </div>

    <!-- Agora SDK from CDN -->
    <script src="https://cdn.agora.io/sdk/release/AgoraRTC_N.js"></script>

    <script>
        // Inline JavaScript
        const toggleBtn = document.getElementById('toggleVoiceBtn');
        const appIdInput = document.getElementById('appIdInput');
        const statusLog = document.getElementById('statusLog');

        let agoraClient = null;
        let localAudioTrack = null;
        let isJoined = false;
        const CHANNEL_NAME = "testchannel";

        // Helper to show logs on the page
        function log(message, isError = false) {
            const entry = document.createElement('div');
            entry.className = 'log-entry';
            if (isError) {
                entry.classList.add('log-error');
            }
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            statusLog.appendChild(entry);
            statusLog.scrollTop = statusLog.scrollHeight; // Auto-scroll to bottom
        }

        async function toggleVoice() {
            if (isJoined) {
                await leaveChannel();
            } else {
                await joinChannel();
            }
        }

        async function joinChannel() {
            const appId = appIdInput.value.trim();
            if (!appId) {
                log("Error: App ID is required.", true);
                return;
            }

            try {
                toggleBtn.disabled = true;
                log("Initializing Agora client...");
                agoraClient = AgoraRTC.createClient({ mode: "rtc", codec: "vp8" });

                // Event listener for when other users join and publish
                agoraClient.on("user-published", async (user, mediaType) => {
                    log(`User ${user.uid} published ${mediaType}. Subscribing...`);
                    await agoraClient.subscribe(user, mediaType);
                    if (mediaType === "audio") {
                        log(`Playing audio from user ${user.uid}.`);
                        user.audioTrack.play();
                    }
                });

                log(`Joining channel "${CHANNEL_NAME}"...`);
                // Use a random UID by passing null
                await agoraClient.join(appId, CHANNEL_NAME, null, null);
                log("Joined channel successfully!");

                log("Creating microphone audio track...");
                localAudioTrack = await AgoraRTC.createMicrophoneAudioTrack();
                log("Microphone track created.");

                log("Publishing local audio to the channel...");
                await agoraClient.publish([localAudioTrack]);
                log("Published successfully! You are now live.");

                isJoined = true;
                toggleBtn.textContent = "Stop Microphone";
                toggleBtn.classList.add('active');

            } catch (error) {
                log(`Error: ${error.message}`, true);
                console.error(error);
            } finally {
                toggleBtn.disabled = false;
            }
        }

        async function leaveChannel() {
            try {
                toggleBtn.disabled = true;
                if (localAudioTrack) {
                    log("Closing local microphone track...");
                    localAudioTrack.close();
                    localAudioTrack = null;
                }
                if (agoraClient) {
                    log("Leaving Agora channel...");
                    await agoraClient.leave();
                    log("Left the channel successfully.");
                }
                isJoined = false;
                toggleBtn.textContent = "Start Microphone";
                toggleBtn.classList.remove('active');
            } catch (error) {
                log(`Error: ${error.message}`, true);
                console.error(error);
            } finally {
                toggleBtn.disabled = false;
            }
        }

        toggleBtn.onclick = toggleVoice;
        log("Test page loaded. Enter App ID and start microphone.");

    </script>
</body>
</html>
